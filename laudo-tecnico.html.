<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laudo Técnico - Celpan</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
  :root {
    --vermelho-principal: #8e2215;
    --vermelho-secundario: #a82a1d;

    --texto-principal: #1f2933;
    --texto-secundario: #4b5563;

    --cinza-claro: #f8f9fa;
    --borda-padrao: #e0e0e0;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
  }

  body {
    background-color: var(--cinza-claro);
    color: var(--texto-principal);
    line-height: 1.3;
    min-height: 100vh;
  }

  .container {
    width: 210mm;
    min-height: 297mm;
    margin: 0 auto;
    padding: 10mm;
    background: #ffffff;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
  }

  /* Popup */
  .popup-container {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .popup {
    background: #ffffff;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  }

  .popup h2 {
    color: var(--texto-principal);
    border-bottom: 2px solid var(--vermelho-principal);
    padding-bottom: 8px;
    margin-bottom: 15px;
  }

  .input-group label {
    font-weight: 600;
    color: var(--texto-principal);
    font-size: 13px;
  }

  .input-group input {
    border: 1px solid #cbd5e0;
    border-radius: 5px;
    padding: 10px;
  }

  .input-group input:focus {
    border-color: var(--vermelho-principal);
    outline: none;
  }

  .btn {
    background: linear-gradient(135deg, var(--vermelho-secundario), var(--vermelho-principal));
    color: #ffffff;
    border: none;
    border-radius: 5px;
    padding: 10px;
    font-weight: 600;
  }

  /* Cabeçalho do laudo */
  .certificate-header {
    text-align: center;
    margin-bottom: 18px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--vermelho-principal);
  }

  .certificate-title {
    font-size: 22px;
    font-weight: 800;
    color: var(--texto-principal);
    text-transform: uppercase;
  }

  .certificate-subtitle {
    color: var(--texto-secundario);
    font-size: 14px;
  }

  .certificate-number {
    color: var(--vermelho-principal);
    font-weight: 700;
    background: var(--cinza-claro);
    padding: 6px 12px;
    border-radius: 15px;
    border: 1px solid var(--borda-padrao);
  }

  /* TÍTULOS DE SEÇÃO → vermelho escuro */
  .section-title {
    background: linear-gradient(135deg, var(--vermelho-secundario), var(--vermelho-principal));
    color: #ffffff;
    padding: 8px 12px;
    margin: 15px 0 10px;
    border-radius: 5px;
    font-weight: 700;
    text-transform: uppercase;
  }

  /* Cards */
  .info-card {
    background: #ffffff;
    border-left: 3px solid var(--vermelho-principal);
    border-radius: 5px;
    padding: 10px;
    box-shadow: 0 1px 5px rgba(0,0,0,.05);
  }

  .info-label {
    font-weight: 700;
    color: var(--texto-principal);
  }

  .info-value {
    color: #333;
    font-weight: 600;
  }

  /* Tabelas */
  .equipment-table,
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
  }

  .equipment-table th,
  .data-table th {
    background: linear-gradient(135deg, var(--vermelho-secundario), var(--vermelho-principal));
    color: #ffffff;
    font-weight: 700;
    padding: 8px 5px;
  }

  .equipment-table td,
  .data-table td {
    border: 1px solid var(--borda-padrao);
    padding: 6px 5px;
  }

  .equipment-table tr:nth-child(even),
  .data-table tr:nth-child(even) {
    background: var(--cinza-claro);
  }

  /* Assinaturas */
  .signature-id {
    color: var(--vermelho-principal);
    font-weight: 700;
  }

  /* Rodapé */
  .footer {
    border-top: 1px solid var(--borda-padrao);
    color: var(--texto-secundario);
    font-size: 10px;
    text-align: center;
  }

  @media print {
    body {
      background: #ffffff;
    }

    .popup-container,
    .btn,
    .controls {
      display: none !important;
    }

    .container {
      box-shadow: none;
      padding: 8mm;
    }
  }
</style>

</head>
<body>
  <div class="container">

    <!-- Popup inicial -->
    <div class="popup-container" id="popupContainer">
  <div class="popup" style="
    width: 420px;
    padding: 26px;
    font-size: 15px;
  ">
    <h2 style="margin-bottom: 18px;">Consulta de Laudo</h2>

    <!-- DADOS DO CLIENTE -->
    <div class="input-group">
      <label>Nome</label>
      <input type="text" id="nome" placeholder="Nome completo">
    </div>

    <div class="input-group">
      <label>CNPJ</label>
      <input type="text" id="cnpj" placeholder="00.000.000/0000-00">
    </div>

    <div class="input-group">
      <label>WhatsApp</label>
      <input type="text" id="zap" placeholder="DDD + número">
    </div>

    <div class="input-group">
      <label>Email</label>
      <input type="email" id="email" placeholder="email@empresa.com">
    </div>

    <hr style="margin:18px 0; opacity:.3;">

    <!-- LAUDO -->
    <div class="input-group">
      <label for="laudoNumber">Número do Laudo (Rastreabilidade)</label>
      <input type="text" id="laudoNumber" placeholder="Digite o número do laudo">
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div class="loading" id="loading">
      <p>Processando...</p>
    </div>

    <button class="btn" id="generateBtn" style="margin-top:10px;">
      Gerar Laudo
    </button>
  </div>
</div>


    <!-- RESTANTE DO SEU HTML DO LAUDO -->
    <!-- (NADA ALTERADO AQUI) -->

  </div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const API_LAUDO = 'https://script.google.com/macros/s/AKfycbwXD_LIit80umqVvBPS071fTwv3tKMl_vUjZlsuvZ-YlsRVUp0YCCJcBgON260f9ry2kA/exec';
  const API_CLIENTE = 'https://script.google.com/macros/s/AKfycbxiVkjAdyBUoGEtoUxqWcjfgWEPZpOyWgSN1TmmhTLRX15F2L6PLiL9E3ElnIdDL24fBQ/exec';

  // ===============================
  // HELPERS SEGUROS
  // ===============================
  function el(id) {
    return document.getElementById(id);
  }

  function setText(id, value) {
    const e = el(id);
    if (e) e.textContent = value ?? '';
  }

  function showLoading(show) {
    if (el('loading')) el('loading').style.display = show ? 'block' : 'none';
    if (el('errorMessage')) el('errorMessage').style.display = 'none';
    if (el('successMessage')) el('successMessage').style.display = 'none';
  }

  function showError(msg) {
    if (el('errorMessage')) {
      el('errorMessage').textContent = msg;
      el('errorMessage').style.display = 'block';
    }
  }

  // ===============================
  // GERAR LAUDO
  // ===============================
  const btn = el('generateBtn');
  if (!btn) return; // segurança absoluta

  btn.addEventListener('click', async function () {

    const numeroLaudo = el('laudoNumber')?.value.trim() || '';

    const nome  = el('nome')?.value || '';
    const cnpj  = el('cnpj')?.value || '';
    const zap   = el('zap')?.value || '';
    const email = el('email')?.value || '';

    if (!numeroLaudo) {
      showError('Digite o número do laudo.');
      return;
    }

    showLoading(true);

    try {
      // ===============================
      // 1️⃣ INSERE CLIENTE (OK / NÃO MEXER)
      // ===============================
      await fetch(
        `${API_CLIENTE}?action=inserirCliente`
        + `&nome=${encodeURIComponent(nome)}`
        + `&cnpj=${encodeURIComponent(cnpj)}`
        + `&zap=${encodeURIComponent(zap)}`
        + `&email=${encodeURIComponent(email)}`
      );

      // ===============================
      // 2️⃣ BUSCA LAUDO (LÓGICA ORIGINAL)
      // ===============================
      const response = await fetch(
        `${API_LAUDO}?action=buscarLaudoPorNumero&numeroLaudo=${encodeURIComponent(numeroLaudo)}`
      );

      const result = await response.json();
      showLoading(false);

      if (!result.success) {
        showError(result.message);
        return;
      }

      const data = result.data;

      // ===============================
      // PREENCHIMENTO DO LAUDO (SEM QUEBRAR)
      // ===============================
      setText('numeroLaudo', data.rastreabilidade);
      setText('productName', data.produto);
      setText('rastreabilidade', data.rastreabilidade);
      setText('mesEnsaio', data.mesEnsaio);
      setText('proximoEnsaio', data.proximoEnsaio);
      setText('produto', data.produto);
      setText('classe', data.classe);

      // ===============================
      // EXIBIR LAUDO
      // ===============================
      if (el('popupContainer')) el('popupContainer').style.display = 'none';
      if (el('certificateContainer')) el('certificateContainer').style.display = 'block';

    } catch (err) {
      showLoading(false);
      showError('Erro ao buscar dados: ' + err.message);
    }
  });

});
</script>

</body>
</html>
