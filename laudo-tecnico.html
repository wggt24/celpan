<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laudo Técnico - Celpan</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
    }

    body {
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.2;
      padding: 0;
      min-height: 100vh;
    }

    .container {
      width: 210mm;
      min-height: 297mm;
      margin: 0 auto;
      padding: 8mm;
      background: white;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    /* Popup inicial */
    .popup-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .popup h2 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 20px;
      border-bottom: 2px solid #a82a1d;
      padding-bottom: 8px;
      display: inline-block;
    }

    .input-group {
      margin-bottom: 15px;
      text-align: left;
    }

    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #cbd5e0;
      border-radius: 5px;
      font-size: 14px;
    }

    .input-group input:focus {
      border-color: #a82a1d;
      outline: none;
    }

    .btn {
      background: linear-gradient(135deg, #a82a1d 0%, #8e2215 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 8px 4px;
      width: 100%;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-download {
      background: linear-gradient(135deg, #38a169 0%, #22543d 100%);
    }

    .btn-print {
      background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
    }

    .loading, .error-message {
      margin: 10px 0;
      padding: 8px;
      border-radius: 5px;
      font-size: 13px;
      display: none;
    }

    .error-message {
      background: #fed7d7;
      color: #c53030;
      border: 1px solid #feb2b2;
    }

    /* Layout do Laudo */
    .certificate-container {
      display: none;
    }

    .certificate-header {
      text-align: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #a82a1d;
    }

    .logo-container {
      margin-bottom: 10px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .logo-container img {
      max-height: 50px;
      width: auto;
    }

    .certificate-title {
      color: #2c3e50;
      font-size: 22px;
      margin-bottom: 6px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .certificate-subtitle {
      color: #7f8c8d;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .certificate-number {
      color: #a82a1d;
      font-size: 13px;
      font-weight: 600;
      background-color: #f8f9fa;
      padding: 6px 12px;
      border-radius: 15px;
      display: inline-block;
      margin-top: 8px;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      background: #a82a1d;
      color: white;
      padding: 8px 12px;
      margin: 12px 0 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }

    .info-card {
      background: #ffffff;
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid #a82a1d;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 11px;
    }

    .info-label {
      font-weight: 600;
      color: #2c3e50;
      white-space: nowrap;
    }

    .info-value {
      color: #333;
      text-align: right;
      font-weight: 500;
    }

    /* Tabelas */
    .equipment-table, .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      margin-bottom: 12px;
    }

    .equipment-table th, .equipment-table td,
    .data-table th, .data-table td {
      padding: 6px 4px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }

    .equipment-table th, .data-table th {
      background: #a82a1d;
      color: white;
      font-weight: 600;
      padding: 6px 4px;
    }

    .equipment-table tr:nth-child(even),
    .data-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .equipment-table td:first-child,
    .equipment-table th:first-child,
    .data-table td:first-child,
    .data-table th:first-child {
      text-align: left;
      padding-left: 6px;
    }

    .equipment-table td:last-child,
    .equipment-table th:last-child,
    .data-table td:last-child,
    .data-table th:last-child {
      text-align: right;
      padding-right: 6px;
    }

    /* Legenda e normas */
    .legenda-normas {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 10px;
      border: 1px solid #e0e0e0;
    }

    /* Assinaturas */
    .signatures-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }

    .signature-box {
      text-align: center;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
    }

    .signature-box img {
      max-width: 150px;
      height: auto;
      margin-bottom: 8px;
    }

    .signature-name {
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .signature-title {
      color: #7f8c8d;
      margin-bottom: 3px;
      font-size: 10px;
      font-weight: 500;
    }

    .signature-id {
      color: #a82a1d;
      font-size: 9px;
      font-weight: 600;
    }

    /* Rodapé */
    .footer {
      text-align: center;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
      color: #7f8c8d;
      font-size: 10px;
      line-height: 1.3;
    }

    /* Controles */
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    /* Estilo para impressão */
    @media print {
      body {
        background: white;
        padding: 0;
        margin: 0;
        width: 210mm;
        height: 297mm;
      }

      .popup-container,
      .btn,
      .controls {
        display: none !important;
      }

      .certificate-container {
        display: block !important;
        padding: 0;
        margin: 0;
        font-size: 9pt;
        width: 100%;
      }

      .container {
        box-shadow: none;
        padding: 5mm;
        margin: 0;
        width: 210mm;
        min-height: 297mm;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Popup inicial -->
    <div class="popup-container" id="popupContainer">
      <div class="popup">
        <h2>Consulta de Laudo</h2>
        <div class="input-group">
          <label for="laudoNumber">Número do Laudo (Rastreabilidade)</label>
          <input type="text" id="laudoNumber" placeholder="Digite o número do laudo" autocomplete="off">
        </div>
        <div class="error-message" id="errorMessage"></div>
        <div class="loading" id="loading">Buscando dados...</div>
        <button class="btn" id="generateBtn">Gerar Laudo</button>
      </div>
    </div>

    <!-- Certificado de Laudo Técnico -->
    <div class="certificate-container" id="certificateContainer">
      <div class="certificate-header">
        <div class="logo-container">
          <img id="companyLogo" src="https://www.celpan.com.br/wp-content/uploads/2021/12/logo.png" alt="Logo Celpan">
        </div>
        <h1 class="certificate-title">Laudo Técnico</h1>
        <div class="certificate-subtitle">EPI / EPC: <span id="productName"></span></div>
        <div class="certificate-number">NÚM: <span id="numeroLaudo"></span></div>
      </div>

      <!-- Informações do ensaio -->
      <div class="section-title">INFORMAÇÕES DO ENSAIO</div>
      <div class="info-grid">
        <div class="info-card">
          <div class="info-item">
            <span class="info-label">Número de Rastreabilidade:</span>
            <span class="info-value" id="rastreabilidade"></span>
          </div>
          <div class="info-item">
            <span class="info-label">Mês do Ensaio:</span>
            <span class="info-value" id="mesEnsaio"></span>
          </div>
        </div>
        <div class="info-card">
          <div class="info-item">
            <span class="info-label">Marca/Fabricante:</span>
            <span class="info-value" id="produto"></span>
          </div>
          <div class="info-item">
            <span class="info-label">Classe:</span>
            <span class="info-value" id="classe"></span>
          </div>
          <div class="info-item">
            <span class="info-label">Próximo Ensaio:</span>
            <span class="info-value" id="proximoEnsaio"></span>
          </div>
        </div>
      </div>

      <!-- Equipamentos utilizados -->
      <div class="section-title">EQUIPAMENTOS UTILIZADOS</div>
      <table class="equipment-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Código</th>
            <th>Certif. Calibração</th>
            <th>Validade</th>
          </tr>
        </thead>
        <tbody id="equipmentTableBody">
          <!-- Preenchido dinamicamente -->
        </tbody>
      </table>

      <!-- Condições do ensaio -->
      <div class="section-title">CONDICÕES DO ENSAIO</div>
      <div class="info-grid">
        <div class="info-card" style="grid-column: 1 / -1;">
          <div class="info-item">
            <span class="info-label">Temperatura:</span>
            <span class="info-value" id="temperatura"></span>
          </div>
          <div class="info-item">
            <span class="info-label">Tempo de Ensaio:</span>
            <span class="info-value" id="tempoEnsaio"></span>
          </div>
          <div class="info-item">
            <span class="info-label">Umidade:</span>
            <span class="info-value" id="umidade"></span>
          </div>
        </div>
      </div>

      <!-- Resultados dos ensaios -->
      <div class="section-title">RESULTADOS DOS ENSAIOS</div>
      <table class="data-table">
        <thead id="dataTableHeader">
          <!-- Preenchido dinamicamente -->
        </thead>
        <tbody id="dataTableBody">
          <!-- Preenchido dinamicamente -->
        </tbody>
      </table>

      <!-- Legenda e normas -->
      <div class="legenda-normas">
        <div><strong>Legenda:</strong> AP = Aprovado | NST = Não Suportou Tensão | RV = Reprovado Visual | FD = Fora do Dimensional</div>
        <div><strong>Normas Referenciadas:</strong> NR-10 / ASTM D-1048-14 / ASTM D178-19 / ASTM F479-06 / NBR-14039/2005</div>
      </div>

      <!-- Assinaturas -->
      <div class="signatures-section">
        <div class="signature-box">
          <img src="https://raw.githubusercontent.com/ticelpan1670-droid/celpan/main/imagens/assinatura-rogerio.png" alt="Assinatura Rogério Percílio Figueiredo">
          <div class="signature-name">Rogério Percílio Figueiredo</div>
          <div class="signature-title">Responsável Técnico</div>
          <div class="signature-id">CREA: 5060011343</div>
        </div>
        <div class="signature-box">
          <img src="https://raw.githubusercontent.com/ticelpan1670-droid/celpan/main/imagens/assinatura-cleber.png" alt="Assinatura Cleber Rodrigo Martins">
          <div class="signature-name">Cleber Rodrigo Martins</div>
          <div class="signature-title">Coordenador de Qualidade</div>
          <div class="signature-id">CREA: 5062345678</div>
        </div>
      </div>

      <!-- Rodapé -->
      <div class="footer">
        <div><strong>CELPAN - COBRA BRASIL SERVIÇOS DE COMUNICAÇÃO E ENERGIA S.A.</strong></div>
        <div>CNPJ: 12.345.678/0001-99</div>
        <div>Estrada da Aldeinha, 1670 - Jardim Marilu - Carapicuíba, São Paulo - CEP: 06343-040</div>
        <div>Contato: (11) 3229-6699 / 3228-6015 / 2967-7040</div>
      </div>

      <!-- Controles -->
      <div class="controls">
        <button class="btn" onclick="voltarConsulta()">Nova Consulta</button>
        <button class="btn btn-download" onclick="downloadPDF()">Download PDF</button>
        <button class="btn btn-print" onclick="window.print()">Imprimir Laudo</button>
      </div>
    </div>
  </div>

  <script>
    /* ======================================
       CONTROLE DE BLOQUEIO (INTELIGENTE)
    ====================================== */
    let bloqueioAtivo = true;

    function ativarBloqueio() {
      bloqueioAtivo = true;
    }

    function desativarBloqueio() {
      bloqueioAtivo = false;
    }

    // Botão direito
    document.addEventListener('contextmenu', function(e) {
      if (bloqueioAtivo) {
        e.preventDefault();
        return false;
      }
    });

    // Teclas perigosas
    document.addEventListener('keydown', function(e) {
      if (!bloqueioAtivo) return;

      if (e.key === 'F12') {
        e.preventDefault();
        return false;
      }

      if (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) {
        e.preventDefault();
        return false;
      }

      if (e.ctrlKey && ['U', 'S'].includes(e.key.toUpperCase())) {
        e.preventDefault();
        return false;
      }
    });

    /* ======================================
       GERAR LAUDO (FETCH)
    ====================================== */
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbx2pkgn8D7wteKbs7ztzo-BIds9l0OmW0yNZG_slb3yNlUbPVdH0DzH8wJfz9bVcOsq/exec';

    document.getElementById('generateBtn').addEventListener('click', async function() {
      var numeroLaudo = document.getElementById('laudoNumber').value.trim();

      if (!numeroLaudo) {
        document.getElementById('errorMessage').textContent = 'Digite o número do laudo.';
        document.getElementById('errorMessage').style.display = 'block';
        return;
      }

      document.getElementById('loading').style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';

      try {
        const response = await fetch(WEBAPP_URL + '?laudo=' + encodeURIComponent(numeroLaudo));
        const result = await response.json();
        document.getElementById('loading').style.display = 'none';

        if (!result.success) {
          document.getElementById('errorMessage').textContent = result.message;
          document.getElementById('errorMessage').style.display = 'block';
          return;
        }

        var data = result.data;

        // Preenche os dados básicos
        document.getElementById('numeroLaudo').textContent = data.rastreabilidade;
        document.getElementById('productName').textContent = data.produto;
        document.getElementById('rastreabilidade').textContent = data.rastreabilidade;
        document.getElementById('mesEnsaio').textContent = data.mesEnsaio;
        document.getElementById('proximoEnsaio').textContent = data.proximoEnsaio;
        document.getElementById('produto').textContent = data.produto;
        document.getElementById('classe').textContent = data.classe;

        // Preenche os equipamentos utilizados
        const equipmentTableBody = document.getElementById('equipmentTableBody');
        equipmentTableBody.innerHTML = '';

        // Exemplo de preenchimento de equipamentos (ajuste conforme os dados reais)
        if (data.equipamentos && data.equipamentos.length > 0) {
          data.equipamentos.forEach(equipamento => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${equipamento.nome || ''}</td>
              <td>${equipamento.codigo || ''}</td>
              <td>${equipamento.certificado || ''}</td>
              <td>${equipamento.validade || ''}</td>
            `;
            equipmentTableBody.appendChild(row);
          });
        } else {
          // Se não houver equipamentos, exibe uma linha vazia
          equipmentTableBody.innerHTML = `
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          `;
        }

        // Preenche as condições do ensaio
        document.getElementById('temperatura').textContent = data.temperatura || '';
        document.getElementById('tempoEnsaio').textContent = data.tempoEnsaio || '';
        document.getElementById('umidade').textContent = data.umidade || '';

        // Preenche os resultados dos ensaios
        const dataTableHeader = document.getElementById('dataTableHeader');
        const dataTableBody = document.getElementById('dataTableBody');

        dataTableHeader.innerHTML = `
          <tr>
            <th>Ensaio</th>
            <th>Resultado</th>
            <th>Status</th>
          </tr>
        `;

        dataTableBody.innerHTML = '';

        // Exemplo de preenchimento de resultados (ajuste conforme os dados reais)
        if (data.resultados && data.resultados.length > 0) {
          data.resultados.forEach(resultado => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${resultado.ensaio || ''}</td>
              <td>${resultado.valor || ''}</td>
              <td>${resultado.status || ''}</td>
            `;
            dataTableBody.appendChild(row);
          });
        } else {
          // Se não houver resultados, exibe uma linha vazia
          dataTableBody.innerHTML = `
            <tr>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          `;
        }

        document.getElementById('popupContainer').style.display = 'none';
        document.getElementById('certificateContainer').style.display = 'block';

      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('errorMessage').textContent = 'Erro ao buscar dados';
        document.getElementById('errorMessage').style.display = 'block';
        console.error(err);
      }
    });

    /* ======================================
       VOLTAR CONSULTA
    ====================================== */
    function voltarConsulta() {
      desativarBloqueio();
      document.getElementById('certificateContainer').style.display = 'none';
      document.getElementById('popupContainer').style.display = 'flex';
      document.getElementById('laudoNumber').value = '';
      ativarBloqueio();
    }

    /* ======================================
       DOWNLOAD PDF (AJUSTADO PARA A4)
    ====================================== */
    async function downloadPDF() {
      desativarBloqueio();

      const { jsPDF } = window.jspdf;
      const element = document.querySelector('.certificate-container');
      const controls = document.querySelector('.controls');

      if (controls) controls.style.display = 'none';

      const canvas = await html2canvas(element, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false,
        letterRendering: true,
      });

      if (controls) controls.style.display = 'flex';

      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const margin = 5;
      const pageWidth = pdf.internal.pageSize.getWidth() - (margin * 2);
      const imgWidth = pageWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);

      const laudoNumber = document.getElementById('numeroLaudo')?.textContent || 'SEM_NUMERO';
      pdf.save(`Laudo_Tecnico_Celpan_${laudoNumber}.pdf`);

      ativarBloqueio();
    }
  </script>
</body>
</html>
